import e from"events";import t from"url";import r from"normalize-url";import c from"get-stream";import o from"http-cache-semantics";import s from"responselike";import a from"lowercase-keys";import i from"clone-response";import n from"keyv";var h={};const l=e;const u=t;const m=r;const f=c;const d=o;const p=s;const C=a;const y=i;const b=n;class CacheableRequest{constructor(e,t){if("function"!==typeof e)throw new TypeError("Parameter `request` must be a function");this.cache=new b({uri:"string"===typeof t&&t,store:"string"!==typeof t&&t,namespace:"cacheable-request"});return this.createCacheableRequest(e)}createCacheableRequest(e){return(t,r)=>{"string"===typeof t&&(t=u.parse(t));t=Object.assign({headers:{},method:"GET",cache:true,strictTtl:false,automaticFailover:false},t);t.headers=C(t.headers);const c=new l;const o=m(u.format(t));const s=`${t.method}:${o}`;let a=false;let i=false;const makeRequest=t=>{i=true;const handler=e=>{if(a){const r=d.fromObject(a.cachePolicy).revalidatedPolicy(t,e);if(!r.modified){const t=r.policy.responseHeaders();e=new p(e.statusCode,t,a.body,a.url);e.cachePolicy=r.policy;e.fromCache=true}}if(!e.fromCache){e.cachePolicy=new d(t,e);e.fromCache=false}let o;if(t.cache&&e.cachePolicy.storable()){o=y(e);f.buffer(e).then(r=>{const c={cachePolicy:e.cachePolicy.toObject(),url:e.url,statusCode:e.fromCache?a.statusCode:e.statusCode,body:r};const o=t.strictTtl?e.cachePolicy.timeToLive():void 0;return this.cache.set(s,c,o)}).catch(e=>c.emit("error",new CacheableRequest.CacheError(e)))}else t.cache&&a&&this.cache.delete(s).catch(e=>c.emit("error",new CacheableRequest.CacheError(e)));c.emit("response",o||e);"function"===typeof r&&r(o||e)};try{const r=e(t,handler);c.emit("request",r)}catch(e){c.emit("error",new CacheableRequest.RequestError(e))}};const get=e=>Promise.resolve().then(()=>e.cache?this.cache.get(s):void 0).then(t=>{if("undefined"===typeof t)return makeRequest(e);const o=d.fromObject(t.cachePolicy);if(o.satisfiesWithoutRevalidation(e)){const e=o.responseHeaders();const s=new p(t.statusCode,e,t.body,t.url);s.cachePolicy=o;s.fromCache=true;c.emit("response",s);"function"===typeof r&&r(s)}else{a=t;e.headers=o.revalidationHeaders(e);makeRequest(e)}});this.cache.on("error",e=>c.emit("error",new CacheableRequest.CacheError(e)));get(t).catch(e=>{t.automaticFailover&&!i&&makeRequest(t);c.emit("error",new CacheableRequest.CacheError(e))});return c}}}CacheableRequest.RequestError=class extends Error{constructor(e){super(e.message);this.name="RequestError";Object.assign(this,e)}};CacheableRequest.CacheError=class extends Error{constructor(e){super(e.message);this.name="CacheError";Object.assign(this,e)}};h=CacheableRequest;var q=h;export default q;

