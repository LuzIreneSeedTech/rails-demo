import e from"fs";import t from"util";import r from"stream";import i from"pend";import o from"events";import n from"process";import f from"buffer";var s="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var a={};var d=f.Buffer;var u=n;var c=e;var l=t;var h=r;var p=h.Readable;var m=h.Writable;var y=h.PassThrough;var S=i;var v=o.EventEmitter;a.createFromBuffer=createFromBuffer;a.createFromFd=createFromFd;a.BufferSlicer=BufferSlicer;a.FdSlicer=FdSlicer;l.inherits(FdSlicer,v);function FdSlicer(e,t){t=t||{};v.call(this||s);(this||s).fd=e;(this||s).pend=new S;(this||s).pend.max=1;(this||s).refCount=0;(this||s).autoClose=!!t.autoClose}FdSlicer.prototype.read=function(e,t,r,i,o){var n=this||s;n.pend.go((function(f){c.read(n.fd,e,t,r,i,(function(e,t,r){f();o(e,t,r)}))}))};FdSlicer.prototype.write=function(e,t,r,i,o){var n=this||s;n.pend.go((function(f){c.write(n.fd,e,t,r,i,(function(e,t,r){f();o(e,t,r)}))}))};FdSlicer.prototype.createReadStream=function(e){return new ReadStream(this||s,e)};FdSlicer.prototype.createWriteStream=function(e){return new WriteStream(this||s,e)};FdSlicer.prototype.ref=function(){(this||s).refCount+=1};FdSlicer.prototype.unref=function(){var e=this||s;e.refCount-=1;if(!(e.refCount>0)){if(e.refCount<0)throw new Error("invalid unref");e.autoClose&&c.close(e.fd,onCloseDone)}function onCloseDone(t){t?e.emit("error",t):e.emit("close")}};l.inherits(ReadStream,p);function ReadStream(e,t){t=t||{};p.call(this||s,t);(this||s).context=e;(this||s).context.ref();(this||s).start=t.start||0;(this||s).endOffset=t.end;(this||s).pos=(this||s).start;(this||s).destroyed=false}ReadStream.prototype._read=function(e){var t=this||s;if(!t.destroyed){var r=Math.min(t._readableState.highWaterMark,e);null!=t.endOffset&&(r=Math.min(r,t.endOffset-t.pos));if(r<=0){t.destroyed=true;t.push(null);t.context.unref()}else t.context.pend.go((function(e){if(t.destroyed)return e();var i=new d(r);c.read(t.context.fd,i,0,r,t.pos,(function(r,o){if(r)t.destroy(r);else if(0===o){t.destroyed=true;t.push(null);t.context.unref()}else{t.pos+=o;t.push(i.slice(0,o))}e()}))}))}};ReadStream.prototype.destroy=function(e){if(!(this||s).destroyed){e=e||new Error("stream destroyed");(this||s).destroyed=true;this.emit("error",e);(this||s).context.unref()}};l.inherits(WriteStream,m);function WriteStream(e,t){t=t||{};m.call(this||s,t);(this||s).context=e;(this||s).context.ref();(this||s).start=t.start||0;(this||s).endOffset=null==t.end?Infinity:+t.end;(this||s).bytesWritten=0;(this||s).pos=(this||s).start;(this||s).destroyed=false;this.on("finish",(this||s).destroy.bind(this||s))}WriteStream.prototype._write=function(e,t,r){var i=this||s;if(!i.destroyed)if(i.pos+e.length>i.endOffset){var o=new Error("maximum file length exceeded");o.code="ETOOBIG";i.destroy();r(o)}else i.context.pend.go((function(t){if(i.destroyed)return t();c.write(i.context.fd,e,0,e.length,i.pos,(function(e,o){if(e){i.destroy();t();r(e)}else{i.bytesWritten+=o;i.pos+=o;i.emit("progress");t();r()}}))}))};WriteStream.prototype.destroy=function(){if(!(this||s).destroyed){(this||s).destroyed=true;(this||s).context.unref()}};l.inherits(BufferSlicer,v);function BufferSlicer(e,t){v.call(this||s);t=t||{};(this||s).refCount=0;(this||s).buffer=e;(this||s).maxChunkSize=t.maxChunkSize||Number.MAX_SAFE_INTEGER}BufferSlicer.prototype.read=function(e,t,r,i,o){var n=i+r;var f=n-(this||s).buffer.length;var a=f>0?f:r;(this||s).buffer.copy(e,t,i,n);u.nextTick((function(){o(null,a)}))};BufferSlicer.prototype.write=function(e,t,r,i,o){e.copy((this||s).buffer,i,t,t+r);u.nextTick((function(){o(null,r,e)}))};BufferSlicer.prototype.createReadStream=function(e){e=e||{};var t=new y(e);t.destroyed=false;t.start=e.start||0;t.endOffset=e.end;t.pos=t.endOffset||(this||s).buffer.length;var r=(this||s).buffer.slice(t.start,t.pos);var i=0;while(true){var o=i+(this||s).maxChunkSize;if(o>=r.length){i<r.length&&t.write(r.slice(i,r.length));break}t.write(r.slice(i,o));i=o}t.end();t.destroy=function(){t.destroyed=true};return t};BufferSlicer.prototype.createWriteStream=function(e){var t=this||s;e=e||{};var r=new m(e);r.start=e.start||0;r.endOffset=null==e.end?(this||s).buffer.length:+e.end;r.bytesWritten=0;r.pos=r.start;r.destroyed=false;r._write=function(e,i,o){if(!r.destroyed){var n=r.pos+e.length;if(n>r.endOffset){var f=new Error("maximum file length exceeded");f.code="ETOOBIG";r.destroyed=true;o(f)}else{e.copy(t.buffer,r.pos,0,e.length);r.bytesWritten+=e.length;r.pos=n;r.emit("progress");o()}}};r.destroy=function(){r.destroyed=true};return r};BufferSlicer.prototype.ref=function(){(this||s).refCount+=1};BufferSlicer.prototype.unref=function(){(this||s).refCount-=1;if((this||s).refCount<0)throw new Error("invalid unref")};function createFromBuffer(e,t){return new BufferSlicer(e,t)}function createFromFd(e,t){return new FdSlicer(e,t)}const F=a.createFromBuffer,g=a.createFromFd,w=a.BufferSlicer,x=a.FdSlicer;export default a;export{w as BufferSlicer,x as FdSlicer,F as createFromBuffer,g as createFromFd};

