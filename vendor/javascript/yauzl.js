import e from"fs";import r from"zlib";import t from"fd-slicer";import n from"buffer-crc32";import o from"util";import i from"events";import a from"stream";import s from"process";import l from"buffer";var d="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var f={};var u=l.Buffer;var c=s;var m=e;var p=r;var E=t;var v=n;var y=o;var h=i.EventEmitter;var g=a.Transform;var w=a.PassThrough;var C=a.Writable;f.open=open;f.fromFd=fromFd;f.fromBuffer=fromBuffer;f.fromRandomAccessReader=fromRandomAccessReader;f.dosDateTimeToDate=dosDateTimeToDate;f.validateFileName=validateFileName;f.ZipFile=ZipFile;f.Entry=Entry;f.RandomAccessReader=RandomAccessReader;function open(e,r,t){if("function"===typeof r){t=r;r=null}null==r&&(r={});null==r.autoClose&&(r.autoClose=true);null==r.lazyEntries&&(r.lazyEntries=false);null==r.decodeStrings&&(r.decodeStrings=true);null==r.validateEntrySizes&&(r.validateEntrySizes=true);null==r.strictFileNames&&(r.strictFileNames=false);null==t&&(t=defaultCallback);m.open(e,"r",(function(e,n){if(e)return t(e);fromFd(n,r,(function(e,r){e&&m.close(n,defaultCallback);t(e,r)}))}))}function fromFd(e,r,t){if("function"===typeof r){t=r;r=null}null==r&&(r={});null==r.autoClose&&(r.autoClose=false);null==r.lazyEntries&&(r.lazyEntries=false);null==r.decodeStrings&&(r.decodeStrings=true);null==r.validateEntrySizes&&(r.validateEntrySizes=true);null==r.strictFileNames&&(r.strictFileNames=false);null==t&&(t=defaultCallback);m.fstat(e,(function(n,o){if(n)return t(n);var i=E.createFromFd(e,{autoClose:true});fromRandomAccessReader(i,o.size,r,t)}))}function fromBuffer(e,r,t){if("function"===typeof r){t=r;r=null}null==r&&(r={});r.autoClose=false;null==r.lazyEntries&&(r.lazyEntries=false);null==r.decodeStrings&&(r.decodeStrings=true);null==r.validateEntrySizes&&(r.validateEntrySizes=true);null==r.strictFileNames&&(r.strictFileNames=false);var n=E.createFromBuffer(e,{maxChunkSize:65536});fromRandomAccessReader(n,e.length,r,t)}function fromRandomAccessReader(e,r,t,n){if("function"===typeof t){n=t;t=null}null==t&&(t={});null==t.autoClose&&(t.autoClose=true);null==t.lazyEntries&&(t.lazyEntries=false);null==t.decodeStrings&&(t.decodeStrings=true);var o=!!t.decodeStrings;null==t.validateEntrySizes&&(t.validateEntrySizes=true);null==t.strictFileNames&&(t.strictFileNames=false);null==n&&(n=defaultCallback);if("number"!==typeof r)throw new Error("expected totalSize parameter to be a number");if(r>Number.MAX_SAFE_INTEGER)throw new Error("zip file too large. only file sizes up to 2^52 are supported due to JavaScript's Number type being an IEEE 754 double.");e.ref();var i=22;var a=65535;var s=Math.min(i+a,r);var l=S(s);var d=r-l.length;readAndAssertNoEof(e,l,0,s,d,(function(a){if(a)return n(a);for(var f=s-i;f>=0;f-=1)if(101010256===l.readUInt32LE(f)){var u=l.slice(f);var c=u.readUInt16LE(4);if(0!==c)return n(new Error("multi-disk zip files are not supported: found disk number: "+c));var m=u.readUInt16LE(10);var p=u.readUInt32LE(16);var E=u.readUInt16LE(20);var v=u.length-i;if(E!==v)return n(new Error("invalid comment length. expected: "+v+". found: "+E));var y=o?decodeBuffer(u,22,u.length,false):u.slice(22);if(!(65535===m||4294967295===p))return n(null,new ZipFile(e,p,r,m,y,t.autoClose,t.lazyEntries,o,t.validateEntrySizes,t.strictFileNames));var h=S(20);var g=d+f-h.length;readAndAssertNoEof(e,h,0,h.length,g,(function(i){if(i)return n(i);if(117853008!==h.readUInt32LE(0))return n(new Error("invalid zip64 end of central directory locator signature"));var a=readUInt64LE(h,8);var s=S(56);readAndAssertNoEof(e,s,0,s.length,a,(function(i){if(i)return n(i);if(101075792!==s.readUInt32LE(0))return n(new Error("invalid zip64 end of central directory record signature"));m=readUInt64LE(s,32);p=readUInt64LE(s,48);return n(null,new ZipFile(e,p,r,m,y,t.autoClose,t.lazyEntries,o,t.validateEntrySizes,t.strictFileNames))}))}));return}n(new Error("end of central directory record signature not found"))}))}y.inherits(ZipFile,h);function ZipFile(e,r,t,n,o,i,a,s,l,f){var u=this||d;h.call(u);u.reader=e;u.reader.on("error",(function(e){emitError(u,e)}));u.reader.once("close",(function(){u.emit("close")}));u.readEntryCursor=r;u.fileSize=t;u.entryCount=n;u.comment=o;u.entriesRead=0;u.autoClose=!!i;u.lazyEntries=!!a;u.decodeStrings=!!s;u.validateEntrySizes=!!l;u.strictFileNames=!!f;u.isOpen=true;u.emittedError=false;u.lazyEntries||u._readEntry()}ZipFile.prototype.close=function(){if((this||d).isOpen){(this||d).isOpen=false;(this||d).reader.unref()}};function emitErrorAndAutoClose(e,r){e.autoClose&&e.close();emitError(e,r)}function emitError(e,r){if(!e.emittedError){e.emittedError=true;e.emit("error",r)}}ZipFile.prototype.readEntry=function(){if(!(this||d).lazyEntries)throw new Error("readEntry() called without lazyEntries:true");this._readEntry()};ZipFile.prototype._readEntry=function(){var e=this||d;if(e.entryCount!==e.entriesRead){if(!e.emittedError){var r=S(46);readAndAssertNoEof(e.reader,r,0,r.length,e.readEntryCursor,(function(t){if(t)return emitErrorAndAutoClose(e,t);if(!e.emittedError){var n=new Entry;var o=r.readUInt32LE(0);if(33639248!==o)return emitErrorAndAutoClose(e,new Error("invalid central directory file header signature: 0x"+o.toString(16)));n.versionMadeBy=r.readUInt16LE(4);n.versionNeededToExtract=r.readUInt16LE(6);n.generalPurposeBitFlag=r.readUInt16LE(8);n.compressionMethod=r.readUInt16LE(10);n.lastModFileTime=r.readUInt16LE(12);n.lastModFileDate=r.readUInt16LE(14);n.crc32=r.readUInt32LE(16);n.compressedSize=r.readUInt32LE(20);n.uncompressedSize=r.readUInt32LE(24);n.fileNameLength=r.readUInt16LE(28);n.extraFieldLength=r.readUInt16LE(30);n.fileCommentLength=r.readUInt16LE(32);n.internalFileAttributes=r.readUInt16LE(36);n.externalFileAttributes=r.readUInt32LE(38);n.relativeOffsetOfLocalHeader=r.readUInt32LE(42);if(64&n.generalPurposeBitFlag)return emitErrorAndAutoClose(e,new Error("strong encryption is not supported"));e.readEntryCursor+=46;r=S(n.fileNameLength+n.extraFieldLength+n.fileCommentLength);readAndAssertNoEof(e.reader,r,0,r.length,e.readEntryCursor,(function(t){if(t)return emitErrorAndAutoClose(e,t);if(!e.emittedError){var o=0!==(2048&n.generalPurposeBitFlag);n.fileName=e.decodeStrings?decodeBuffer(r,0,n.fileNameLength,o):r.slice(0,n.fileNameLength);var i=n.fileNameLength+n.extraFieldLength;var a=r.slice(n.fileNameLength,i);n.extraFields=[];var s=0;while(s<a.length-3){var l=a.readUInt16LE(s+0);var d=a.readUInt16LE(s+2);var f=s+4;var u=f+d;if(u>a.length)return emitErrorAndAutoClose(e,new Error("extra field length exceeds extra field buffer size"));var c=S(d);a.copy(c,0,f,u);n.extraFields.push({id:l,data:c});s=u}n.fileComment=e.decodeStrings?decodeBuffer(r,i,i+n.fileCommentLength,o):r.slice(i,i+n.fileCommentLength);n.comment=n.fileComment;e.readEntryCursor+=r.length;e.entriesRead+=1;if(4294967295===n.uncompressedSize||4294967295===n.compressedSize||4294967295===n.relativeOffsetOfLocalHeader){var m=null;for(var s=0;s<n.extraFields.length;s++){var p=n.extraFields[s];if(1===p.id){m=p.data;break}}if(null==m)return emitErrorAndAutoClose(e,new Error("expected zip64 extended information extra field"));var E=0;if(4294967295===n.uncompressedSize){if(E+8>m.length)return emitErrorAndAutoClose(e,new Error("zip64 extended information extra field does not include uncompressed size"));n.uncompressedSize=readUInt64LE(m,E);E+=8}if(4294967295===n.compressedSize){if(E+8>m.length)return emitErrorAndAutoClose(e,new Error("zip64 extended information extra field does not include compressed size"));n.compressedSize=readUInt64LE(m,E);E+=8}if(4294967295===n.relativeOffsetOfLocalHeader){if(E+8>m.length)return emitErrorAndAutoClose(e,new Error("zip64 extended information extra field does not include relative header offset"));n.relativeOffsetOfLocalHeader=readUInt64LE(m,E);E+=8}}if(e.decodeStrings)for(var s=0;s<n.extraFields.length;s++){var p=n.extraFields[s];if(28789===p.id){if(p.data.length<6)continue;if(1!==p.data.readUInt8(0))continue;var y=p.data.readUInt32LE(1);if(v.unsigned(r.slice(0,n.fileNameLength))!==y)continue;n.fileName=decodeBuffer(p.data,5,p.data.length,true);break}}if(e.validateEntrySizes&&0===n.compressionMethod){var h=n.uncompressedSize;n.isEncrypted()&&(h+=12);if(n.compressedSize!==h){var g="compressed/uncompressed size mismatch for stored file: "+n.compressedSize+" != "+n.uncompressedSize;return emitErrorAndAutoClose(e,new Error(g))}}if(e.decodeStrings){e.strictFileNames||(n.fileName=n.fileName.replace(/\\/g,"/"));var w=validateFileName(n.fileName,e.validateFileNameOptions);if(null!=w)return emitErrorAndAutoClose(e,new Error(w))}e.emit("entry",n);e.lazyEntries||e._readEntry()}}))}}))}}else c.nextTick((function(){e.autoClose&&e.close();e.emittedError||e.emit("end")}))};ZipFile.prototype.openReadStream=function(e,r,t){var n=this||d;var o=0;var i=e.compressedSize;if(null==t){t=r;r={}}else{if(null!=r.decrypt){if(!e.isEncrypted())throw new Error("options.decrypt can only be specified for encrypted entries");if(false!==r.decrypt)throw new Error("invalid options.decrypt value: "+r.decrypt);if(e.isCompressed()&&false!==r.decompress)throw new Error("entry is encrypted and compressed, and options.decompress !== false")}if(null!=r.decompress){if(!e.isCompressed())throw new Error("options.decompress can only be specified for compressed entries");if(!(false===r.decompress||true===r.decompress))throw new Error("invalid options.decompress value: "+r.decompress)}if(null!=r.start||null!=r.end){if(e.isCompressed()&&false!==r.decompress)throw new Error("start/end range not allowed for compressed entry without options.decompress === false");if(e.isEncrypted()&&false!==r.decrypt)throw new Error("start/end range not allowed for encrypted entry without options.decrypt === false")}if(null!=r.start){o=r.start;if(o<0)throw new Error("options.start < 0");if(o>e.compressedSize)throw new Error("options.start > entry.compressedSize")}if(null!=r.end){i=r.end;if(i<0)throw new Error("options.end < 0");if(i>e.compressedSize)throw new Error("options.end > entry.compressedSize");if(i<o)throw new Error("options.end < options.start")}}if(!n.isOpen)return t(new Error("closed"));if(e.isEncrypted()&&false!==r.decrypt)return t(new Error("entry is encrypted, and options.decrypt !== false"));n.reader.ref();var a=S(30);readAndAssertNoEof(n.reader,a,0,a.length,e.relativeOffsetOfLocalHeader,(function(s){try{if(s)return t(s);var l=a.readUInt32LE(0);if(67324752!==l)return t(new Error("invalid local file header signature: 0x"+l.toString(16)));var d=a.readUInt16LE(26);var f=a.readUInt16LE(28);var u=e.relativeOffsetOfLocalHeader+a.length+d+f;var m;if(0===e.compressionMethod)m=false;else{if(8!==e.compressionMethod)return t(new Error("unsupported compression method: "+e.compressionMethod));m=null==r.decompress||r.decompress}var E=u;var v=E+e.compressedSize;if(0!==e.compressedSize&&v>n.fileSize)return t(new Error("file data overflows file bounds: "+E+" + "+e.compressedSize+" > "+n.fileSize));var y=n.reader.createReadStream({start:E+o,end:E+i});var h=y;if(m){var g=false;var w=p.createInflateRaw();y.on("error",(function(e){c.nextTick((function(){g||w.emit("error",e)}))}));y.pipe(w);if(n.validateEntrySizes){h=new AssertByteCountStream(e.uncompressedSize);w.on("error",(function(e){c.nextTick((function(){g||h.emit("error",e)}))}));w.pipe(h)}else h=w;h.destroy=function(){g=true;w!==h&&w.unpipe(h);y.unpipe(w);y.destroy()}}t(null,h)}finally{n.reader.unref()}}))};function Entry(){}Entry.prototype.getLastModDate=function(){return dosDateTimeToDate((this||d).lastModFileDate,(this||d).lastModFileTime)};Entry.prototype.isEncrypted=function(){return 0!==(1&(this||d).generalPurposeBitFlag)};Entry.prototype.isCompressed=function(){return 8===(this||d).compressionMethod};function dosDateTimeToDate(e,r){var t=31&e;var n=(e>>5&15)-1;var o=(e>>9&127)+1980;var i=0;var a=2*(31&r);var s=r>>5&63;var l=r>>11&31;return new Date(o,n,t,l,s,a,i)}function validateFileName(e){return-1!==e.indexOf("\\")?"invalid characters in fileName: "+e:/^[a-zA-Z]:/.test(e)||/^\//.test(e)?"absolute path: "+e:-1!==e.split("/").indexOf("..")?"invalid relative path: "+e:null}function readAndAssertNoEof(e,r,t,n,o,i){if(0===n)return c.nextTick((function(){i(null,S(0))}));e.read(r,t,n,o,(function(e,r){if(e)return i(e);if(r<n)return i(new Error("unexpected EOF"));i()}))}y.inherits(AssertByteCountStream,g);function AssertByteCountStream(e){g.call(this||d);(this||d).actualByteCount=0;(this||d).expectedByteCount=e}AssertByteCountStream.prototype._transform=function(e,r,t){(this||d).actualByteCount+=e.length;if((this||d).actualByteCount>(this||d).expectedByteCount){var n="too many bytes in the stream. expected "+(this||d).expectedByteCount+". got at least "+(this||d).actualByteCount;return t(new Error(n))}t(null,e)};AssertByteCountStream.prototype._flush=function(e){if((this||d).actualByteCount<(this||d).expectedByteCount){var r="not enough bytes in the stream. expected "+(this||d).expectedByteCount+". got only "+(this||d).actualByteCount;return e(new Error(r))}e()};y.inherits(RandomAccessReader,h);function RandomAccessReader(){h.call(this||d);(this||d).refCount=0}RandomAccessReader.prototype.ref=function(){(this||d).refCount+=1};RandomAccessReader.prototype.unref=function(){var e=this||d;e.refCount-=1;if(!(e.refCount>0)){if(e.refCount<0)throw new Error("invalid unref");e.close(onCloseDone)}function onCloseDone(r){if(r)return e.emit("error",r);e.emit("close")}};RandomAccessReader.prototype.createReadStream=function(e){var r=e.start;var t=e.end;if(r===t){var n=new w;c.nextTick((function(){n.end()}));return n}var o=this._readStreamForRange(r,t);var i=false;var a=new RefUnrefFilter(this||d);o.on("error",(function(e){c.nextTick((function(){i||a.emit("error",e)}))}));a.destroy=function(){o.unpipe(a);a.unref();o.destroy()};var s=new AssertByteCountStream(t-r);a.on("error",(function(e){c.nextTick((function(){i||s.emit("error",e)}))}));s.destroy=function(){i=true;a.unpipe(s);a.destroy()};return o.pipe(a).pipe(s)};RandomAccessReader.prototype._readStreamForRange=function(e,r){throw new Error("not implemented")};RandomAccessReader.prototype.read=function(e,r,t,n,o){var i=this.createReadStream({start:n,end:n+t});var a=new C;var s=0;a._write=function(t,n,o){t.copy(e,r+s,0,t.length);s+=t.length;o()};a.on("finish",o);i.on("error",(function(e){o(e)}));i.pipe(a)};RandomAccessReader.prototype.close=function(e){c.nextTick(e)};y.inherits(RefUnrefFilter,w);function RefUnrefFilter(e){w.call(this||d);(this||d).context=e;(this||d).context.ref();(this||d).unreffedYet=false}RefUnrefFilter.prototype._flush=function(e){this.unref();e()};RefUnrefFilter.prototype.unref=function(e){if(!(this||d).unreffedYet){(this||d).unreffedYet=true;(this||d).context.unref()}};var z="\0☺☻♥♦♣♠•◘○◙♂♀♪♫☼►◄↕‼¶§▬↨↑↓→←∟↔▲▼ !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~⌂ÇüéâäàåçêëèïîìÄÅÉæÆôöòûùÿÖÜ¢£¥₧ƒáíóúñÑªº¿⌐¬½¼¡«»░▒▓│┤╡╢╖╕╣║╗╝╜╛┐└┴┬├─┼╞╟╚╔╩╦╠═╬╧╨╤╥╙╘╒╓╫╪┘┌█▄▌▐▀αßΓπΣσµτΦΘΩδ∞φε∩≡±≥≤⌠⌡÷≈°∙·√ⁿ²■ ";function decodeBuffer(e,r,t,n){if(n)return e.toString("utf8",r,t);var o="";for(var i=r;i<t;i++)o+=z[e[i]];return o}function readUInt64LE(e,r){var t=e.readUInt32LE(r);var n=e.readUInt32LE(r+4);return 4294967296*n+t}var S;S="function"===typeof u.allocUnsafe?function(e){return u.allocUnsafe(e)}:function(e){return new u(e)};function defaultCallback(e){if(e)throw e}const A=f.open,F=f.fromFd,L=f.fromBuffer,R=f.fromRandomAccessReader,x=f.dosDateTimeToDate,U=f.validateFileName,N=f.ZipFile,I=f.Entry,B=f.RandomAccessReader;export default f;export{I as Entry,B as RandomAccessReader,N as ZipFile,x as dosDateTimeToDate,L as fromBuffer,F as fromFd,R as fromRandomAccessReader,A as open,U as validateFileName};

